<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canaan Baptist Church - Accounting System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-indigo-900 mb-2">üèõÔ∏è Canaan Baptist Church</h1>
                <p class="text-gray-600">Accounting System</p>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üîê Login</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="loginEmail" 
                        class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-indigo-500 focus:outline-none" 
                        placeholder="your.email@church.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="loginPassword" 
                        class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-indigo-500 focus:outline-none" 
                        placeholder="Enter password">
                </div>
                <button onclick="login()" 
                    class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-medium">
                    Login
                </button>
                <div id="loginError" class="text-red-600 text-sm text-center hidden"></div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 hidden items-center justify-center z-50">
        <div class="text-center">
            <div class="inline-block w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-gray-700 font-medium mt-4">Loading...</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="p-6 hidden"></div>

    <script>
        // Global Supabase client - DECLARED ONLY ONCE
        let supabaseClient;

        // Wait for DOM and scripts to load
        window.addEventListener('load', function() {
            console.log('Page loaded');
            initializeApp();
        });

        function initializeApp() {
            console.log('Initializing...');
            
            // Check if Supabase loaded
            if (!window.supabase) {
                alert('Failed to load Supabase. Please refresh the page.');
                return;
            }

            // Initialize Supabase
            const SUPABASE_URL = 'https://isvqwielxbbmplwpzaob.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzdnF3aWVseGJibXBsd3B6YW9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNDkyNzIsImV4cCI6MjA4MzYyNTI3Mn0.G3M9RZTfxyguC9-bt-HIVfCAgQR3c0epqfm4w_ureq4';
            
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('‚úÖ Supabase initialized');

            // Check for existing session
            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    document.getElementById('loginEmail').value = session.user.email;
                }
            });
        }

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let state = {
            user: null,
            church: null,
            branch: null,
            transactions: [],
            tithes: [],
            members: [],
            categories: [],
            currentTab: 'dashboard',
            selectedMonth: '',
            form: {
                type: 'income',
                category: '',
                amount: '',
                date: new Date().toISOString().split('T')[0],
                description: ''
            }
        };

        // ============================================
        // AUTHENTICATION
        // ============================================
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!email || !password) {
                showError(errorDiv, "Please enter email and password");
                return;
            }

            showLoading(true);

            try {
                console.log('Attempting login...');

                const { data: authData, error: authError } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (authError) throw authError;

                console.log('Auth successful');

                // Get user profile
                const { data: userData, error: userError } = await supabaseClient
                    .from('profiles')
                    .select(`
                        id,
                        role,
                        church_id,
                        churches (
                            id,
                            name,
                            church_code
                        )
                    `)
                    .eq('id', authData.user.id)
                    .single();

                if (userError) throw new Error(`Profile error: ${userError.message}`);
                if (!userData || !userData.churches) throw new Error('User not linked to a church');

                state.user = {
                    id: userData.id,
                    email: authData.user.email,
                    role: userData.role,
                    name: authData.user.email.split('@')[0]
                };

                state.church = userData.churches;

                // Get or create branch
                const { data: branches, error: branchError } = await supabaseClient
                    .from('branches')
                    .select('*')
                    .eq('church_id', state.church.id)
                    .limit(1);

                if (branchError) throw branchError;

                if (branches && branches.length > 0) {
                    state.branch = branches[0];
                } else {
                    const { data: newBranch, error: createError } = await supabaseClient
                        .from('branches')
                        .insert({
                            church_id: state.church.id,
                            name: 'Main Branch',
                            address: 'Main Office'
                        })
                        .select()
                        .single();

                    if (createError) throw createError;
                    state.branch = newBranch;
                }

                await loadData();

                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                showLoading(false);
                render();

            } catch (error) {
                console.error('Login failed:', error);
                showLoading(false);
                showError(errorDiv, error.message || 'Login failed');
            }
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadData() {
            try {
                // Load categories
                const { data: cats, error: catsError } = await supabaseClient
                    .from('categories')
                    .select('*')
                    .eq('church_id', state.church.id)
                    .order('name');

                if (catsError) throw catsError;
                state.categories = cats || [];

                if (state.categories.length === 0) {
                    await createDefaultCategories();
                }

                // Load transactions
                const { data: txns, error: txnsError } = await supabaseClient
                    .from('transactions')
                    .select('*')
                    .eq('branch_id', state.branch.id)
                    .order('date', { ascending: false });

                if (txnsError) throw txnsError;
                state.transactions = txns || [];

                // Load tithes
                const { data: tithes, error: tithesError } = await supabaseClient
                    .from('tithe_records')
                    .select('*')
                    .eq('branch_id', state.branch.id)
                    .order('date', { ascending: false });

                if (tithesError) throw tithesError;
                state.tithes = tithes || [];

                // Load members
                const { data: members, error: membersError } = await supabaseClient
                    .from('members')
                    .select('*')
                    .eq('church_id', state.church.id)
                    .order('name');

                if (membersError) throw membersError;
                state.members = members || [];

            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data: ' + error.message);
            }
        }

        async function createDefaultCategories() {
            const defaults = [
                { name: 'Tithe', type: 'income', church_id: state.church.id },
                { name: 'Offering', type: 'income', church_id: state.church.id },
                { name: 'Donation', type: 'income', church_id: state.church.id },
                { name: 'Rent', type: 'expense', church_id: state.church.id },
                { name: 'Utilities', type: 'expense', church_id: state.church.id },
                { name: 'Salaries', type: 'expense', church_id: state.church.id },
                { name: 'Maintenance', type: 'expense', church_id: state.church.id }
            ];

            const { data, error } = await supabaseClient
                .from('categories')
                .insert(defaults)
                .select();

            if (!error) state.categories = data;
        }

        // ============================================
        // TRANSACTIONS
        // ============================================
        async function addTransaction() {
            const category = document.getElementById('txnCategory').value;
            const amount = parseFloat(document.getElementById('txnAmount').value);
            const date = document.getElementById('txnDate').value;
            const description = document.getElementById('txnDesc').value;

            if (!category || !amount || !date) {
                alert('Please fill all required fields');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('transactions')
                    .insert({
                        church_id: state.church.id,
                        branch_id: state.branch.id,
                        type: state.form.type,
                        category: category,
                        amount: amount,
                        date: date,
                        description: description,
                        added_by: state.user.id
                    })
                    .select()
                    .single();

                if (error) throw error;

                state.transactions.unshift(data);
                state.form = {
                    type: 'income',
                    category: '',
                    amount: '',
                    date: new Date().toISOString().split('T')[0],
                    description: ''
                };

                render();
                alert('‚úÖ Transaction added!');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteTransaction(id) {
            if (!confirm('Delete this transaction?')) return;

            try {
                const { error } = await supabaseClient
                    .from('transactions')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                state.transactions = state.transactions.filter(t => t.id !== id);
                render();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ============================================
        // TITHES
        // ============================================
        async function addTithe() {
            const member = document.getElementById('titheMember').value;
            const amount = parseFloat(document.getElementById('titheAmount').value);
            const date = document.getElementById('titheDate').value;

            if (!member || !amount || !date) {
                alert('Please fill all fields');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('tithe_records')
                    .insert({
                        church_id: state.church.id,
                        branch_id: state.branch.id,
                        member_name: member,
                        amount: amount,
                        date: date,
                        recorded_by: state.user.id
                    })
                    .select()
                    .single();

                if (error) throw error;

                state.tithes.unshift(data);
                document.getElementById('titheAmount').value = '';
                render();
                alert('‚úÖ Tithe recorded!');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteTithe(id) {
            if (!confirm('Delete this tithe record?')) return;

            try {
                const { error } = await supabaseClient
                    .from('tithe_records')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                state.tithes = state.tithes.filter(t => t.id !== id);
                render();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ============================================
        // MEMBERS
        // ============================================
        async function addMember() {
            const name = prompt('Enter member name:');
            if (!name || !name.trim()) return;

            try {
                const { data, error } = await supabaseClient
                    .from('members')
                    .insert({
                        church_id: state.church.id,
                        name: name.trim()
                    })
                    .select()
                    .single();

                if (error) throw error;

                state.members.push(data);
                render();
                alert('‚úÖ Member added!');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ============================================
        // UI HELPERS
        // ============================================
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            } else {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        }

        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 5000);
        }

        function logout() {
            if (confirm('Logout?')) {
                supabaseClient.auth.signOut();
                location.reload();
            }
        }

        function switchTab(tab) {
            state.currentTab = tab;
            render();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-NG', {
                style: 'currency',
                currency: 'NGN',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function getMonthlyStats() {
            const now = new Date();
            const currentMonth = state.selectedMonth || `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const filtered = state.transactions.filter(t => t.date.startsWith(currentMonth));
            const income = filtered.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const expenses = filtered.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
            return { income, expenses, balance: income - expenses, count: filtered.length };
        }

        function getAllTimeStats() {
            const income = state.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const expenses = state.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const totalTithes = state.tithes.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            return { income, expenses, balance: income - expenses, totalTithes };
        }

        function getMonthOptions() {
            const months = new Set();
            state.transactions.forEach(t => {
                const month = t.date.substring(0, 7);
                months.add(month);
            });
            return Array.from(months).sort().reverse();
        }

        // ============================================
        // RENDERING
        // ============================================
        function render() {
            const app = document.getElementById('app');
            if (!state.user) return;

            app.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h1 class="text-3xl font-bold text-indigo-900">üèõÔ∏è ${state.church.name}</h1>
                            <p class="text-gray-600 mt-1">Branch: ${state.branch.name} | User: ${state.user.name} (${state.user.role})</p>
                        </div>
                        <button onclick="logout()" class="px-6 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition font-medium">
                            Logout
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-xl p-4 mb-6">
                    <div class="flex gap-2 flex-wrap">
                        ${['dashboard', 'transactions', 'tithe', 'reports'].map(tab => `
                            <button onclick="switchTab('${tab}')" 
                                class="px-6 py-3 rounded-lg font-medium transition ${state.currentTab === tab ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                ${tab === 'dashboard' ? 'üìä Dashboard' : tab === 'transactions' ? 'üí∞ Transactions' : tab === 'tithe' ? 'üìñ Tithes' : 'üìà Reports'}
                            </button>
                        `).join('')}
                    </div>
                </div>

                ${state.currentTab === 'dashboard' ? renderDashboard() : 
                  state.currentTab === 'transactions' ? renderTransactions() :
                  state.currentTab === 'tithe' ? renderTithe() :
                  renderReports()}
            `;

            attachListeners();
        }

        function renderDashboard() {
            const stats = getAllTimeStats();
            return `
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-xl p-6 text-white">
                        <div class="text-sm opacity-90 mb-2">Total Income</div>
                        <div class="text-3xl font-bold">${formatCurrency(stats.income)}</div>
                    </div>
                    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-xl p-6 text-white">
                        <div class="text-sm opacity-90 mb-2">Total Expenses</div>
                        <div class="text-3xl font-bold">${formatCurrency(stats.expenses)}</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-xl p-6 text-white">
                        <div class="text-sm opacity-90 mb-2">Balance</div>
                        <div class="text-3xl font-bold">${formatCurrency(stats.balance)}</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-xl p-6 text-white">
                        <div class="text-sm opacity-90 mb-2">Total Tithes</div>
                        <div class="text-3xl font-bold">${formatCurrency(stats.totalTithes)}</div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Quick Stats</h2>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <div class="text-gray-600 text-sm">Total Transactions</div>
                            <div class="text-2xl font-bold text-blue-600">${state.transactions.length}</div>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg">
                            <div class="text-gray-600 text-sm">Tithe Records</div>
                            <div class="text-2xl font-bold text-green-600">${state.tithes.length}</div>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-lg">
                            <div class="text-gray-600 text-sm">Members</div>
                            <div class="text-2xl font-bold text-purple-600">${state.members.length}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderReports() {
            const months = getMonthOptions();
            const stats = getMonthlyStats();
            
            return `
                <div class="bg-white rounded-lg shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üìà Monthly Reports</h2>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Month</label>
                        <select id="monthSelect" class="border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-indigo-500 focus:outline-none">
                            <option value="">Current Month</option>
                            ${months.map(m => `<option value="${m}" ${state.selectedMonth === m ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                    </div>
                    <div class="grid md:grid-cols-3 gap-6 mb-6">
                        <div class="p-6 bg-green-50 rounded-lg">
                            <div class="text-gray-600 mb-2">Income</div>
                            <div class="text-2xl font-bold text-green-600">${formatCurrency(stats.income)}</div>
                        </div>
                        <div class="p-6 bg-red-50 rounded-lg">
                            <div class="text-gray-600 mb-2">Expenses</div>
                            <div class="text-2xl font-bold text-red-600">${formatCurrency(stats.expenses)}</div>
                        </div>
                        <div class="p-6 bg-blue-50 rounded-lg">
                            <div class="text-gray-600 mb-2">Balance</div>
                            <div class="text-2xl font-bold text-blue-600">${formatCurrency(stats.balance)}</div>
                        </div>
                    </div>
                    <div class="text-center text-gray-600">${stats.count} transactions this month</div>
                </div>
            `;
        }

        function renderTransactions() {
            const cats = state.categories.filter(c => c.type === state.form.type);

            return `
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">‚ûï Add Transaction</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                                <select id="txnType" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-indigo-500 focus:outline-none">
                                    <option value="income" ${state.form.type === 'income' ? 'selected' : ''}>Income</option>
                                    <option value="expense" ${state.form.type === 'expense' ? 'selected' : ''}>Expense</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                <select id="txnCategory" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-indigo-500 focus:outline-none">
                                    <option value="">Select category...</option>
                                    ${cats.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (‚Ç¶)</label>
                                <input type="number" id="txnAmount" value="${state.form.amount}" step="0.01" 
                                    class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-indigo-500 focus:outline-none" 
                                    placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                <input type="date" id="txnDate" value="${state.form.date}" 
                                    class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-indigo-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <input type="text" id="txnDesc" value="${state.form.description}" 
                                    class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-indigo-500 focus:outline-none" 
                                    placeholder="Optional notes...">
                            </div>
                            <button onclick="addTransaction()" 
                                class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-medium text-lg">
                                Add Transaction
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã Transactions (${state.transactions.length})</h2>
                        ${state.transactions.length === 0 ? '<p class="text-center text-gray-500 py-8">No transactions yet</p>' :
                            `<div class="space-y-2 max-h-[600px] overflow-y-auto">
                                ${state.transactions.map(t => `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                                        <div class="flex-1">
                                            <div class="font-medium">${t.category}</div>
                                            <div class="text-sm text-gray-600">${t.date}</div>
                                        </div>
                                        <div class="text-right mr-2">
                                            <div class="font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                                                ${formatCurrency(t.amount)}
                                            </div>
                                        </div>
                                        <button onclick="deleteTransaction('${t.id}')" 
                                            class="px-3 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 text-sm">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                </div>
            `;
        }

        function renderTithe() {
            return `
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">‚ûï Record Tithe</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Member</label>
                                <select id="titheMember" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-indigo-500 focus:outline-none">
                                    <option value="">Select member...</option>
                                    <option value="Anonymous">Anonymous</option>
                                    ${state.members.map(m => `<option value="${m.name}">${m.name}</option>`).join('')}
                                </select>
                                <button onclick="addMember()" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                                    + Add New Member
                                </button>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (‚Ç¶)</label>
                                <input type="number" id="titheAmount" step="0.01" 
                                    class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-indigo-500 focus:outline-none" 
                                    placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                <input type="date" id="titheDate" value="${new Date().toISOString().split('T')[0]}" 
                                    class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-indigo-500 focus:outline-none">
                            </div>
                            <button onclick="addTithe()" 
                                class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-medium text-lg">
                                Record Tithe
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìñ Tithe Records (${state.tithes.length})</h2>
                        ${state.tithes.length === 0 ? '<p class="text-center text-gray-500 py-8">No tithe records yet</p>' :
                            `<div class="space-y-2 max-h-[600px] overflow-y-auto">
                                ${state.tithes.map(t => `
                                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100">
                                        <div>
                                            <div class="font-medium text-gray-800">${t.member_name}</div>
                                            <div class="text-sm text-gray-600">${t.date}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xl font-bold text-green-600">${formatCurrency(t.amount)}</div>
                                            <button onclick="deleteTithe('${t.id}')" 
                                                class="text-xs text-red-600 hover:text-red-800 mt-1">
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                </div>
            `;
        }

        function attachListeners() {
            const typeEl = document.getElementById('txnType');
            const categoryEl = document.getElementById('txnCategory');
            const amountEl = document.getElementById('txnAmount');
            const dateEl = document.getElementById('txnDate');
            const descEl = document.getElementById('txnDesc');
            const monthEl = document.getElementById('monthSelect');

            if (typeEl) typeEl.onchange = e => { state.form.type = e.target.value; render(); };
            if (categoryEl) categoryEl.onchange = e => state.form.category = e.target.value;
            if (amountEl) amountEl.oninput = e => state.form.amount = e.target.value;
            if (dateEl) dateEl.onchange = e => state.form.date = e.target.value;
            if (descEl) descEl.oninput = e => state.form.description = e.target.value;
            if (monthEl) monthEl.onchange = e => { state.selectedMonth = e.target.value; render(); };
        }
    </script>
</body>
</html>
